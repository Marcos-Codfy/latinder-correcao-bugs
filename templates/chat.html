{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/chat.css' %}">
{% endblock %}

{% block content %}
<div class="chat-container chat-container-glass">
    
    <div class="chat-header">
        
        <a href="{% url 'matches' %}" class="text-white text-decoration-none fs-3 me-2" aria-label="Voltar para Matches" title="Voltar para Matches">
            &larr;
        </a>
        {% with other_pet.petphoto_set.first as first_photo %}
            {% if first_photo %}
                <img src="{{ first_photo.image.url }}" alt="{{ other_pet.name }}">
            {% else %}
                <div style="width: 50px; height: 50px; background: white; border-radius: 50%; display: flex; align-items-center; justify-content: center;">
                    ğŸ¾
                </div>
            {% endif %}
        {% endwith %}
        <div>
            <h5 class="mb-0">{{ other_pet.name }}</h5>
            <small>{{ other_pet.owner.user.get_full_name|default:other_pet.owner.user.username }}</small>
        </div>
    </div>
    
    <div class="messages-area" 
         id="messagesArea" 
         data-last-message-id="{% if messages %}{{ messages.last.id }}{% else %}0{% endif %}">
        {% for message in messages %}
            <div class="message {% if message.sender == request.user.owner %}mine{% else %}theirs{% endif %}" 
                 data-message-id="{{ message.id }}">
                <div class="message-bubble">
                    {{ message.content }}
                </div>
                <div class="message-time" data-timestamp="{{ message.timestamp.isoformat }}">
                    </div>
            </div>
        {% empty %}
            <div id="emptyChatMessage" class="text-center text-muted mt-5" style="color: #eee !important; text-shadow: 1px 1px 2px rgba(0,0,0,0.4);">
                <p>Nenhuma mensagem ainda. Comece a conversa! ğŸ’¬</p>
            </div>
        {% endfor %}
    </div>
    
    <div class="chat-input-area">
        <form id="messageForm">
            {% csrf_token %}
            <input type="hidden" id="matchId" value="{{ match.id }}">
            <input type="text" 
                   id="messageInput" 
                   placeholder="Digite sua mensagem..." 
                   required 
                   autocomplete="off">
            <button type="submit">Enviar</button>
        </form>
    </div>
    
</div>
{% endblock %}

{% block extra_js %}
    <script src="{% static 'js/chat.js' %}"></script>
{% endblock %}